name: Auto-sync Infrastructure to Branches

on:
  push:
    branches: [main]
    paths:
      - 'CLAUDE.md'
      - '.shared-context/**'
      - '.cursor/**'
      - '.github/workflows/**'
      - '.eslintrc.js'
      - '.prettierrc'
      - 'package.json'
      - 'package-lock.json'

jobs:
  sync:
    name: Sync Infrastructure to Branches
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Sync to branches
        run: |
          echo "ðŸ”„ Starting automatic sync..."
          branches=$(git branch -r | grep -v "origin/main" | grep -v "HEAD" | sed 's/origin\///' | sed 's/^[ ]*//')
          
          for branch in $branches; do
            echo "ðŸ”„ Syncing to $branch..."
            git fetch origin "$branch:$branch" 2>/dev/null || true
            git checkout "$branch" 2>/dev/null || continue
            if git merge main --no-edit --no-ff 2>/dev/null; then
              git push origin "$branch" 2>/dev/null && echo "âœ… $branch synced" || echo "âš ï¸  $branch push failed"
            else
              echo "âš ï¸  Conflict in $branch"
              git merge --abort 2>/dev/null || true
            fi
          done
          git checkout main 2>/dev/null || true
