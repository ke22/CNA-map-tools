<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­æ–‡æ ‡ç­¾æ‹–æ›³åŠŸèƒ½ - å†’çƒŸæµ‹è¯•</title>
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            font-family: monospace;
        }
        .test-pass {
            background: #d4edda;
            color: #155724;
        }
        .test-fail {
            background: #f8d7da;
            color: #721c24;
        }
        .test-warn {
            background: #fff3cd;
            color: #856404;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        #test-output {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª ä¸­æ–‡æ ‡ç­¾æ‹–æ›³åŠŸèƒ½ - å†’çƒŸæµ‹è¯•</h1>
    
    <div class="test-container" style="background: #fff3cd; border-left: 4px solid #ffc107;">
        <h2>âš ï¸ é‡è¦æç¤º</h2>
        <p><strong>æ­¤æµ‹è¯•é¡µé¢æ— æ³•è®¿é—®ä¸»é¡µé¢çš„ appState å¯¹è±¡ã€‚</strong></p>
        <p>è¯·ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•ä¹‹ä¸€è¿›è¡Œæµ‹è¯•ï¼š</p>
        <ol>
            <li><strong>æ¨èæ–¹æ³•ï¼š</strong>åœ¨ä¸»é¡µé¢æ§åˆ¶å°è¿è¡Œæµ‹è¯•
                <ul>
                    <li>æ‰“å¼€ä¸»é¡µé¢: <code>http://localhost:8000/index-enhanced.html</code></li>
                    <li>æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å° (F12)</li>
                    <li>å¤åˆ¶ <code>test-label-drag-console.js</code> çš„å†…å®¹å¹¶ç²˜è´´è¿è¡Œ</li>
                </ul>
            </li>
            <li>æˆ–è€…ï¼šåœ¨ä¸»é¡µé¢ä¸­æ‰“å¼€æ­¤æµ‹è¯•é¡µé¢ï¼ˆä½¿ç”¨ iframe æˆ–ç›´æ¥åœ¨æ§åˆ¶å°è¿è¡Œæµ‹è¯•è„šæœ¬ï¼‰</li>
        </ol>
    </div>
    
    <div class="test-container">
        <h2>æµ‹è¯•æ§åˆ¶</h2>
        <button onclick="runSmokeTest()">è¿è¡Œå†’çƒŸæµ‹è¯•</button>
        <button onclick="testLabelDrag()">æµ‹è¯•æ ‡ç­¾æ‹–æ›³ï¼ˆéœ€è¦å…ˆæ·»åŠ æ ‡ç­¾ï¼‰</button>
        <button onclick="clearOutput()">æ¸…é™¤è¾“å‡º</button>
        <button onclick="window.open('http://localhost:8000/index-enhanced.html', '_blank')">æ‰“å¼€ä¸»é¡µé¢</button>
    </div>
    
    <div class="test-container">
        <h2>æµ‹è¯•è¾“å‡º</h2>
        <div id="test-output">ç‚¹å‡»"è¿è¡Œå†’çƒŸæµ‹è¯•"æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>
    </div>
    
    <script>
        function log(message, type = 'info') {
            const output = document.getElementById('test-output');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warn' ? 'âš ï¸' : 'â„¹ï¸';
            output.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            output.scrollTop = output.scrollHeight;
        }
        
        function clearOutput() {
            document.getElementById('test-output').textContent = '';
        }
        
        function checkMainPageContext() {
            // æ£€æŸ¥æ˜¯å¦åœ¨ä¸»é¡µé¢ä¸Šä¸‹æ–‡ä¸­
            if (typeof window.appState === 'undefined') {
                log('âš ï¸ æ£€æµ‹åˆ°ä¸åœ¨ä¸»é¡µé¢ä¸Šä¸‹æ–‡ä¸­', 'warn');
                log('', 'info');
                log('ğŸ“‹ è§£å†³æ–¹æ¡ˆ:', 'info');
                log('   æ–¹æ³• 1: åœ¨ä¸»é¡µé¢ (index-enhanced.html) çš„æ§åˆ¶å°ä¸­è¿è¡Œæµ‹è¯•', 'info');
                log('   æ–¹æ³• 2: ä½¿ç”¨ test-label-drag-console.js è„šæœ¬', 'info');
                log('', 'info');
                log('ğŸ’¡ æ¨èæ–¹æ³•:', 'info');
                log('   1. æ‰“å¼€ä¸»é¡µé¢: http://localhost:8000/index-enhanced.html', 'info');
                log('   2. æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å° (F12)', 'info');
                log('   3. å¤åˆ¶ test-label-drag-console.js çš„å†…å®¹å¹¶ç²˜è´´è¿è¡Œ', 'info');
                return false;
            }
            return true;
        }
        
        function runSmokeTest() {
            clearOutput();
            log('å¼€å§‹ä¸­æ–‡æ ‡ç­¾æ‹–æ›³åŠŸèƒ½å†’çƒŸæµ‹è¯•...', 'info');
            
            // æ£€æŸ¥æ˜¯å¦åœ¨ä¸»é¡µé¢ä¸Šä¸‹æ–‡ä¸­
            if (!checkMainPageContext()) {
                return;
            }
            
            const tests = [];
            let passed = 0;
            let failed = 0;
            let warned = 0;
            
            // æµ‹è¯• 1: æ£€æŸ¥ appState æ˜¯å¦å­˜åœ¨
            tests.push(() => {
                if (!window.appState) {
                    return { name: 'appState å¯¹è±¡', status: 'fail', message: 'appState æœªå®šä¹‰' };
                }
                return { name: 'appState å¯¹è±¡', status: 'pass', message: 'appState å­˜åœ¨' };
            });
            
            // æµ‹è¯• 2: æ£€æŸ¥åœ°å›¾æ˜¯å¦åŠ è½½
            tests.push(() => {
                if (!window.appState || !window.appState.map) {
                    return { name: 'åœ°å›¾åŠ è½½', status: 'fail', message: 'åœ°å›¾æœªåˆå§‹åŒ–' };
                }
                if (!window.appState.map.loaded()) {
                    return { name: 'åœ°å›¾åŠ è½½', status: 'warn', message: 'åœ°å›¾æ­£åœ¨åŠ è½½ä¸­' };
                }
                return { name: 'åœ°å›¾åŠ è½½', status: 'pass', message: 'åœ°å›¾å·²åŠ è½½' };
            });
            
            // æµ‹è¯• 3: æ£€æŸ¥æ ‡ç­¾æ•°æ®æº
            tests.push(() => {
                if (!window.appState || !window.appState.map) {
                    return { name: 'æ ‡ç­¾æ•°æ®æº', status: 'fail', message: 'åœ°å›¾æœªåˆå§‹åŒ–' };
                }
                const source = window.appState.map.getSource('custom-chinese-labels');
                if (!source) {
                    return { name: 'æ ‡ç­¾æ•°æ®æº', status: 'warn', message: 'æ ‡ç­¾æ•°æ®æºä¸å­˜åœ¨ï¼ˆå¯èƒ½è¿˜æ²¡æœ‰é€‰ä¸­åŒºåŸŸï¼‰' };
                }
                return { name: 'æ ‡ç­¾æ•°æ®æº', status: 'pass', message: 'æ ‡ç­¾æ•°æ®æºå­˜åœ¨' };
            });
            
            // æµ‹è¯• 4: æ£€æŸ¥æ ‡ç­¾å›¾å±‚
            tests.push(() => {
                if (!window.appState || !window.appState.map) {
                    return { name: 'æ ‡ç­¾å›¾å±‚', status: 'fail', message: 'åœ°å›¾æœªåˆå§‹åŒ–' };
                }
                const layer = window.appState.map.getLayer('custom-chinese-labels');
                if (!layer) {
                    return { name: 'æ ‡ç­¾å›¾å±‚', status: 'warn', message: 'æ ‡ç­¾å›¾å±‚ä¸å­˜åœ¨ï¼ˆå¯èƒ½è¿˜æ²¡æœ‰é€‰ä¸­åŒºåŸŸï¼‰' };
                }
                return { name: 'æ ‡ç­¾å›¾å±‚', status: 'pass', message: 'æ ‡ç­¾å›¾å±‚å­˜åœ¨' };
            });
            
            // æµ‹è¯• 5: æ£€æŸ¥ hit-area å›¾å±‚
            tests.push(() => {
                if (!window.appState || !window.appState.map) {
                    return { name: 'Hit-area å›¾å±‚', status: 'fail', message: 'åœ°å›¾æœªåˆå§‹åŒ–' };
                }
                const layer = window.appState.map.getLayer('custom-chinese-labels-hit-area');
                if (!layer) {
                    return { name: 'Hit-area å›¾å±‚', status: 'warn', message: 'Hit-area å›¾å±‚ä¸å­˜åœ¨ï¼ˆå¯èƒ½è¿˜æ²¡æœ‰é€‰ä¸­åŒºåŸŸï¼‰' };
                }
                return { name: 'Hit-area å›¾å±‚', status: 'pass', message: 'Hit-area å›¾å±‚å­˜åœ¨' };
            });
            
            // æµ‹è¯• 6: æ£€æŸ¥æ‹–æ›³çŠ¶æ€å¯¹è±¡
            tests.push(() => {
                if (!window.appState || !window.appState.labelDragState) {
                    return { name: 'æ‹–æ›³çŠ¶æ€å¯¹è±¡', status: 'fail', message: 'æ‹–æ›³çŠ¶æ€å¯¹è±¡ä¸å­˜åœ¨' };
                }
                const dragState = window.appState.labelDragState;
                const requiredProps = ['isDragging', 'draggedFeatureId', 'dragStartPoint', 'hasMoved'];
                const missingProps = requiredProps.filter(prop => !(prop in dragState));
                if (missingProps.length > 0) {
                    return { name: 'æ‹–æ›³çŠ¶æ€å¯¹è±¡', status: 'fail', message: `ç¼ºå°‘å±æ€§: ${missingProps.join(', ')}` };
                }
                return { name: 'æ‹–æ›³çŠ¶æ€å¯¹è±¡', status: 'pass', message: 'æ‹–æ›³çŠ¶æ€å¯¹è±¡ç»“æ„æ­£ç¡®' };
            });
            
            // æµ‹è¯• 7: æ£€æŸ¥äº‹ä»¶å¤„ç†å™¨
            tests.push(() => {
                if (!window.appState || !window.appState.map) {
                    return { name: 'äº‹ä»¶å¤„ç†å™¨', status: 'fail', message: 'åœ°å›¾æœªåˆå§‹åŒ–' };
                }
                if (!window.appState.map._labelDragHandlers) {
                    return { name: 'äº‹ä»¶å¤„ç†å™¨', status: 'fail', message: 'äº‹ä»¶å¤„ç†å™¨æœªæ³¨å†Œ' };
                }
                const handlers = window.appState.map._labelDragHandlers;
                const requiredHandlers = ['mousedown', 'mousemove', 'mouseup', 'mouseenter', 'mouseleave'];
                const missingHandlers = requiredHandlers.filter(handler => !(handler in handlers));
                if (missingHandlers.length > 0) {
                    return { name: 'äº‹ä»¶å¤„ç†å™¨', status: 'fail', message: `ç¼ºå°‘å¤„ç†å™¨: ${missingHandlers.join(', ')}` };
                }
                return { name: 'äº‹ä»¶å¤„ç†å™¨', status: 'pass', message: 'æ‰€æœ‰äº‹ä»¶å¤„ç†å™¨å·²æ³¨å†Œ' };
            });
            
            // æµ‹è¯• 8: æ£€æŸ¥ labelPositions
            tests.push(() => {
                if (!window.appState || !window.appState.labelPositions) {
                    return { name: 'æ ‡ç­¾ä½ç½®å­˜å‚¨', status: 'warn', message: 'labelPositions å¯¹è±¡ä¸å­˜åœ¨ï¼ˆå°†åœ¨é¦–æ¬¡æ‹–æ›³æ—¶åˆ›å»ºï¼‰' };
                }
                return { name: 'æ ‡ç­¾ä½ç½®å­˜å‚¨', status: 'pass', message: 'labelPositions å¯¹è±¡å­˜åœ¨' };
            });
            
            // è¿è¡Œæ‰€æœ‰æµ‹è¯•
            log('='.repeat(60), 'info');
            
            tests.forEach((test, index) => {
                try {
                    const result = test();
                    const statusIcon = result.status === 'pass' ? 'âœ…' : result.status === 'fail' ? 'âŒ' : 'âš ï¸';
                    log(`${index + 1}. ${result.name}: ${statusIcon} ${result.message}`, result.status === 'pass' ? 'success' : result.status === 'fail' ? 'error' : 'warn');
                    
                    if (result.status === 'pass') {
                        passed++;
                    } else if (result.status === 'fail') {
                        failed++;
                    } else {
                        warned++;
                    }
                } catch (error) {
                    log(`${index + 1}. æµ‹è¯•æ‰§è¡Œå¤±è´¥: ${error.message}`, 'error');
                    failed++;
                }
            });
            
            log('='.repeat(60), 'info');
            log(`\næµ‹è¯•æ€»ç»“:`, 'info');
            log(`  âœ… é€šè¿‡: ${passed}`, 'success');
            log(`  âŒ å¤±è´¥: ${failed}`, failed > 0 ? 'error' : 'info');
            log(`  âš ï¸ è­¦å‘Š: ${warned}`, warned > 0 ? 'warn' : 'info');
            
            if (failed === 0) {
                log('\nğŸ‰ æ‰€æœ‰å…³é”®æµ‹è¯•é€šè¿‡ï¼ä¸­æ–‡æ ‡ç­¾æ‹–æ›³åŠŸèƒ½åº”è¯¥å¯ä»¥æ­£å¸¸å·¥ä½œã€‚', 'success');
            } else {
                log('\nâš ï¸ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä¸Šè¿°é”™è¯¯ä¿¡æ¯ã€‚', 'error');
            }
            
            // æä¾›æ‰‹åŠ¨æµ‹è¯•æŒ‡å¼•
            log('\nğŸ“ æ‰‹åŠ¨æµ‹è¯•æŒ‡å¼•:', 'info');
            log('  1. åœ¨ä¸»é¡µé¢ä½¿ç”¨ AI åˆ†æåŠŸèƒ½æ·»åŠ ä¸€äº›åŒºåŸŸ', 'info');
            log('  2. ç­‰å¾…ä¸­æ–‡æ ‡ç­¾å‡ºç°', 'info');
            log('  3. å°è¯•ç‚¹å‡»å¹¶æ‹–æ›³ä¸­æ–‡æ ‡ç­¾', 'info');
            log('  4. éªŒè¯æ ‡ç­¾æ˜¯å¦ç‹¬ç«‹ç§»åŠ¨ï¼ˆåœ°å›¾ä¸åº”ç§»åŠ¨ï¼‰', 'info');
            log('  5. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯', 'info');
        }
        
        function testLabelDrag() {
            clearOutput();
            log('æµ‹è¯•æ ‡ç­¾æ‹–æ›³åŠŸèƒ½...', 'info');
            
            // æ£€æŸ¥æ˜¯å¦åœ¨ä¸»é¡µé¢ä¸Šä¸‹æ–‡ä¸­
            if (!checkMainPageContext()) {
                return;
            }
            
            if (!window.appState || !window.appState.map) {
                log('âŒ åœ°å›¾æœªåˆå§‹åŒ–ï¼Œæ— æ³•æµ‹è¯•', 'error');
                log('ğŸ’¡ æç¤º: è¯·ç¡®ä¿åœ¨ä¸»é¡µé¢ (index-enhanced.html) ä¸­è¿è¡Œæ­¤æµ‹è¯•', 'warn');
                return;
            }
            
            const source = window.appState.map.getSource('custom-chinese-labels');
            if (!source) {
                log('âš ï¸ æ ‡ç­¾æ•°æ®æºä¸å­˜åœ¨ï¼Œè¯·å…ˆæ·»åŠ ä¸€äº›åŒºåŸŸ', 'warn');
                return;
            }
            
            const data = source._data;
            if (!data || !data.features || data.features.length === 0) {
                log('âš ï¸ æ²¡æœ‰æ ‡ç­¾ï¼Œè¯·å…ˆæ·»åŠ ä¸€äº›åŒºåŸŸ', 'warn');
                return;
            }
            
            log(`æ‰¾åˆ° ${data.features.length} ä¸ªæ ‡ç­¾`, 'success');
            
            // æ£€æŸ¥æ‹–æ›³çŠ¶æ€
            const dragState = window.appState.labelDragState;
            if (dragState) {
                log(`æ‹–æ›³çŠ¶æ€: isDragging=${dragState.isDragging}, hasMoved=${dragState.hasMoved}`, 'info');
            }
            
            // æ£€æŸ¥äº‹ä»¶å¤„ç†å™¨
            if (window.appState.map._labelDragHandlers) {
                log('âœ… äº‹ä»¶å¤„ç†å™¨å·²æ³¨å†Œ', 'success');
            } else {
                log('âŒ äº‹ä»¶å¤„ç†å™¨æœªæ³¨å†Œ', 'error');
            }
            
            log('\nâœ… æ ‡ç­¾æ‹–æ›³åŠŸèƒ½å·²å°±ç»ªï¼Œå¯ä»¥å¼€å§‹æ‰‹åŠ¨æµ‹è¯•', 'success');
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è¿è¡Œæµ‹è¯•
        window.addEventListener('load', function() {
            setTimeout(() => {
                if (typeof window.appState === 'undefined') {
                    log('âš ï¸ æ£€æµ‹åˆ°ä¸åœ¨ä¸»é¡µé¢ä¸Šä¸‹æ–‡ä¸­', 'warn');
                    log('', 'info');
                    log('ğŸ“‹ è¯·ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•ä¹‹ä¸€è¿›è¡Œæµ‹è¯•:', 'info');
                    log('', 'info');
                    log('æ–¹æ³• 1: åœ¨ä¸»é¡µé¢æ§åˆ¶å°è¿è¡Œæµ‹è¯•ï¼ˆæ¨èï¼‰', 'info');
                    log('   1. æ‰“å¼€ä¸»é¡µé¢: http://localhost:8000/index-enhanced.html', 'info');
                    log('   2. æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å° (F12)', 'info');
                    log('   3. å¤åˆ¶ test-label-drag-console.js çš„å†…å®¹å¹¶ç²˜è´´è¿è¡Œ', 'info');
                    log('', 'info');
                    log('æ–¹æ³• 2: ä½¿ç”¨æ­¤æµ‹è¯•é¡µé¢', 'info');
                    log('   æ³¨æ„: æ­¤æµ‹è¯•é¡µé¢æ— æ³•è®¿é—®ä¸»é¡µé¢çš„ appState', 'warn');
                    log('   å»ºè®®ä½¿ç”¨ä¸»é¡µé¢æ§åˆ¶å°è¿›è¡Œæµ‹è¯•', 'info');
                } else {
                    log('âœ… æ£€æµ‹åˆ°ä¸»é¡µé¢ä¸Šä¸‹æ–‡ï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•', 'success');
                }
            }, 1000);
        });
    </script>
</body>
</html>

