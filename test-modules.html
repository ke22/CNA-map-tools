<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨¡å—æµ‹è¯• - EventBus, StateManager, MarkerIconManager</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 { color: #333; margin-top: 0; }
        h2 { color: #666; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        button {
            background: #6CA7A1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover { background: #5a9490; }
        button:active { background: #4a8380; }
        .log-output {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-top: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .success { color: #4caf50; }
        .error { color: #f44336; }
        .info { color: #2196f3; }
        .icon-preview {
            display: inline-block;
            margin: 5px;
            border: 1px solid #ddd;
            padding: 5px;
            border-radius: 4px;
        }
        .icon-preview img {
            display: block;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª æ¨¡å—æµ‹è¯•é¡µé¢</h1>
    <p>æµ‹è¯• EventBusã€StateManager å’Œ MarkerIconManager æ¨¡å—</p>

    <!-- EventBus æµ‹è¯• -->
    <div class="test-section">
        <h2>1. EventBus æµ‹è¯•</h2>
        <button onclick="testEventBusBasic()">åŸºæœ¬äº‹ä»¶æµ‹è¯•</button>
        <button onclick="testEventBusOnce()">ä¸€æ¬¡æ€§äº‹ä»¶æµ‹è¯•</button>
        <button onclick="testEventBusStats()">äº‹ä»¶ç»Ÿè®¡</button>
        <button onclick="clearEventBusLog()">æ¸…ç©ºæ—¥å¿—</button>
        <div id="eventbus-log" class="log-output"></div>
    </div>

    <!-- StateManager æµ‹è¯• -->
    <div class="test-section">
        <h2>2. StateManager æµ‹è¯•</h2>
        <button onclick="testStateManagerInit()">åˆå§‹åŒ–çŠ¶æ€</button>
        <button onclick="testStateManagerSet()">è®¾ç½®çŠ¶æ€</button>
        <button onclick="testStateManagerSubscribe()">è®¢é˜…çŠ¶æ€å˜åŒ–</button>
        <button onclick="testStateManagerUpdate()">æ‰¹é‡æ›´æ–°</button>
        <button onclick="clearStateManagerLog()">æ¸…ç©ºæ—¥å¿—</button>
        <div id="statemanager-log" class="log-output"></div>
    </div>

    <!-- MarkerIconManager æµ‹è¯• -->
    <div class="test-section">
        <h2>3. MarkerIconManager æµ‹è¯•</h2>
        <button onclick="testMarkerIcons()">ç”Ÿæˆå›¾æ ‡</button>
        <button onclick="testMarkerIconCache()">ç¼“å­˜æµ‹è¯•</button>
        <button onclick="clearMarkerIconLog()">æ¸…ç©ºæ—¥å¿—</button>
        <div id="markericon-log" class="log-output"></div>
        <div id="icon-preview"></div>
    </div>

    <!-- é›†æˆæµ‹è¯• -->
    <div class="test-section">
        <h2>4. é›†æˆæµ‹è¯•</h2>
        <button onclick="testIntegration()">æ¨¡å—é›†æˆæµ‹è¯•</button>
        <button onclick="clearIntegrationLog()">æ¸…ç©ºæ—¥å¿—</button>
        <div id="integration-log" class="log-output"></div>
    </div>

    <!-- åŠ è½½æ ¸å¿ƒæ¨¡å— -->
    <script src="js/core/Logger.js?v=2"></script>
    <script src="js/core/EventBus.js?v=2"></script>
    <script src="js/core/StateManager.js?v=2"></script>
    <script src="js/modules/MarkerIconManager.js?v=2"></script>

    <script>
        // EventBus æµ‹è¯•
        function logEventBus(message, type = 'info') {
            const log = document.getElementById('eventbus-log');
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'â„¹ï¸';
            log.textContent += `[${new Date().toLocaleTimeString()}] ${prefix} ${message}\n`;
            log.scrollTop = log.scrollHeight;
        }

        function clearEventBusLog() {
            document.getElementById('eventbus-log').textContent = '';
        }

        function testEventBusBasic() {
            logEventBus('æµ‹è¯•åŸºæœ¬äº‹ä»¶è®¢é˜…å’Œå‘å¸ƒ...');
            
            // è®¢é˜…äº‹ä»¶
            const unsubscribe = EventBus.on('test:click', (data) => {
                logEventBus(`æ”¶åˆ°äº‹ä»¶: test:click, æ•°æ®: ${JSON.stringify(data)}`, 'success');
            });

            // å‘å¸ƒäº‹ä»¶
            EventBus.emit('test:click', { x: 100, y: 200 });
            EventBus.emit('test:click', { message: 'Hello EventBus!' });

            // å–æ¶ˆè®¢é˜…
            unsubscribe();
            EventBus.emit('test:click', { shouldNotReceive: true });
            logEventBus('å–æ¶ˆè®¢é˜…åï¼Œåº”è¯¥ä¸ä¼šæ”¶åˆ°ä¸Šé¢çš„æ¶ˆæ¯', 'success');
        }

        function testEventBusOnce() {
            logEventBus('æµ‹è¯•ä¸€æ¬¡æ€§äº‹ä»¶...');
            
            EventBus.once('test:once', (data) => {
                logEventBus(`æ”¶åˆ°ä¸€æ¬¡æ€§äº‹ä»¶: ${JSON.stringify(data)}`, 'success');
            });

            EventBus.emit('test:once', { first: true });
            EventBus.emit('test:once', { second: true }); // ä¸åº”è¯¥æ”¶åˆ°
            logEventBus('ç¬¬äºŒæ¬¡äº‹ä»¶åº”è¯¥ä¸ä¼šè§¦å‘ï¼ˆä¸€æ¬¡æ€§è®¢é˜…å·²è‡ªåŠ¨å–æ¶ˆï¼‰', 'success');
        }

        function testEventBusStats() {
            const stats = EventBus.getStats();
            logEventBus(`äº‹ä»¶ç»Ÿè®¡: ${JSON.stringify(stats, null, 2)}`, 'info');
        }

        // StateManager æµ‹è¯•
        function logStateManager(message, type = 'info') {
            const log = document.getElementById('statemanager-log');
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'â„¹ï¸';
            log.textContent += `[${new Date().toLocaleTimeString()}] ${prefix} ${message}\n`;
            log.scrollTop = log.scrollHeight;
        }

        function clearStateManagerLog() {
            document.getElementById('statemanager-log').textContent = '';
        }

        function testStateManagerInit() {
            logStateManager('åˆå§‹åŒ–çŠ¶æ€ç®¡ç†å™¨...');
            StateManager.init({ count: 0, user: null, theme: 'light' });
            logStateManager(`åˆå§‹åŒ–å®Œæˆ: ${JSON.stringify(StateManager.getAll())}`, 'success');
        }

        function testStateManagerSet() {
            logStateManager('è®¾ç½®çŠ¶æ€å€¼...');
            StateManager.set('count', 10);
            StateManager.set('user', { name: 'Test User', id: 1 });
            logStateManager(`è®¾ç½®åçš„çŠ¶æ€: ${JSON.stringify(StateManager.getAll())}`, 'success');
        }

        function testStateManagerSubscribe() {
            logStateManager('è®¢é˜…çŠ¶æ€å˜åŒ–...');
            
            const unsubscribe = StateManager.subscribe('count', (newVal, oldVal) => {
                logStateManager(`count å˜åŒ–: ${oldVal} -> ${newVal}`, 'success');
            });

            StateManager.set('count', 20);
            StateManager.set('count', 30);

            unsubscribe();
            StateManager.set('count', 40); // ä¸åº”è¯¥è§¦å‘ç›‘å¬å™¨
            logStateManager('å–æ¶ˆè®¢é˜…åï¼Œåº”è¯¥ä¸ä¼šæ”¶åˆ°ä¸Šé¢çš„å˜åŒ–é€šçŸ¥', 'success');
        }

        function testStateManagerUpdate() {
            logStateManager('æ‰¹é‡æ›´æ–°çŠ¶æ€...');
            StateManager.update({
                count: 100,
                theme: 'dark',
                user: { name: 'Updated User', id: 2 }
            });
            logStateManager(`æ‰¹é‡æ›´æ–°åçš„çŠ¶æ€: ${JSON.stringify(StateManager.getAll())}`, 'success');
        }

        // MarkerIconManager æµ‹è¯•
        function logMarkerIcon(message, type = 'info') {
            const log = document.getElementById('markericon-log');
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'â„¹ï¸';
            log.textContent += `[${new Date().toLocaleTimeString()}] ${prefix} ${message}\n`;
            log.scrollTop = log.scrollHeight;
        }

        function clearMarkerIconLog() {
            document.getElementById('markericon-log').textContent = '';
            document.getElementById('icon-preview').innerHTML = '';
        }

        function testMarkerIcons() {
            logMarkerIcon('ç”Ÿæˆä¸åŒç±»å‹çš„å›¾æ ‡...');
            const preview = document.getElementById('icon-preview');
            preview.innerHTML = '';

            const colors = ['#6CA7A1', '#FF6B6B', '#4ECDC4', '#95E1D3'];
            const types = ['default', 'location', 'pin'];

            types.forEach(type => {
                colors.forEach(color => {
                    const iconUrl = MarkerIconManager.getIconUrl(type, color, 40);
                    const div = document.createElement('div');
                    div.className = 'icon-preview';
                    div.innerHTML = `
                        <img src="${iconUrl}" alt="${type}-${color}">
                        <div style="text-align: center; font-size: 10px; margin-top: 5px;">
                            ${type}<br>${color}
                        </div>
                    `;
                    preview.appendChild(div);
                });
            });

            logMarkerIcon(`ç”Ÿæˆäº† ${types.length * colors.length} ä¸ªå›¾æ ‡`, 'success');
        }

        function testMarkerIconCache() {
            logMarkerIcon('æµ‹è¯•å›¾æ ‡ç¼“å­˜...');
            const stats1 = MarkerIconManager.getCacheStats();
            logMarkerIcon(`åˆå§‹ç¼“å­˜: ${stats1.cacheSize} ä¸ªå›¾æ ‡`);

            // ç”Ÿæˆç›¸åŒçš„å›¾æ ‡ï¼ˆåº”è¯¥ä½¿ç”¨ç¼“å­˜ï¼‰
            MarkerIconManager.getIconUrl('default', '#FF0000', 40);
            MarkerIconManager.getIconUrl('default', '#FF0000', 40);
            MarkerIconManager.getIconUrl('default', '#FF0000', 40);

            const stats2 = MarkerIconManager.getCacheStats();
            logMarkerIcon(`ç”Ÿæˆ3æ¬¡ç›¸åŒå›¾æ ‡åç¼“å­˜: ${stats2.cacheSize} ä¸ªå›¾æ ‡ï¼ˆåº”è¯¥åªæœ‰1ä¸ªï¼‰`, 'success');

            MarkerIconManager.clearCache();
            const stats3 = MarkerIconManager.getCacheStats();
            logMarkerIcon(`æ¸…ç©ºç¼“å­˜å: ${stats3.cacheSize} ä¸ªå›¾æ ‡`, 'success');
        }

        // é›†æˆæµ‹è¯•
        function logIntegration(message, type = 'info') {
            const log = document.getElementById('integration-log');
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'â„¹ï¸';
            log.textContent += `[${new Date().toLocaleTimeString()}] ${prefix} ${message}\n`;
            log.scrollTop = log.scrollHeight;
        }

        function clearIntegrationLog() {
            document.getElementById('integration-log').textContent = '';
        }

        function testIntegration() {
            logIntegration('å¼€å§‹é›†æˆæµ‹è¯•...');

            // 1. ä½¿ç”¨ StateManager ç®¡ç†åº”ç”¨çŠ¶æ€
            StateManager.init({ markerCount: 0, selectedColor: '#6CA7A1' });
            logIntegration('âœ… StateManager åˆå§‹åŒ–æˆåŠŸ', 'success');

            // 2. ä½¿ç”¨ EventBus å‘å¸ƒçŠ¶æ€å˜åŒ–äº‹ä»¶
            StateManager.subscribe('markerCount', (newVal, oldVal) => {
                EventBus.emit('marker:countChanged', { count: newVal, previous: oldVal });
                logIntegration(`âœ… é€šè¿‡ EventBus å‘å¸ƒ marker:countChanged äº‹ä»¶`, 'success');
            });

            EventBus.on('marker:countChanged', (data) => {
                logIntegration(`âœ… æ”¶åˆ° marker:countChanged äº‹ä»¶: count=${data.count}`, 'success');
            });

            StateManager.set('markerCount', 5);
            logIntegration('âœ… StateManager -> EventBus é›†æˆæˆåŠŸ', 'success');

            // 3. ä½¿ç”¨ MarkerIconManager ç”Ÿæˆå›¾æ ‡
            const icon = MarkerIconManager.getIcon('default', StateManager.get('selectedColor'));
            logIntegration(`âœ… MarkerIconManager ç”Ÿæˆå›¾æ ‡æˆåŠŸ: ${icon.url.substring(0, 50)}...`, 'success');

            // 4. æ‰€æœ‰æ¨¡å—æ­£å¸¸å·¥ä½œ
            logIntegration('âœ… æ‰€æœ‰æ¨¡å—é›†æˆæµ‹è¯•é€šè¿‡ï¼', 'success');
        }

        // é¡µé¢åŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', () => {
            Logger.info('æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
            logEventBus('EventBus æ¨¡å—å·²åŠ è½½', 'success');
            logStateManager('StateManager æ¨¡å—å·²åŠ è½½', 'success');
            logMarkerIcon('MarkerIconManager æ¨¡å—å·²åŠ è½½', 'success');
            logIntegration('æ‰€æœ‰æ¨¡å—å·²åŠ è½½ï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•', 'success');
        });
    </script>
</body>
</html>

