<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Mapbox Boundary Sources - Fixed</title>
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin: 0; font-family: Arial, sans-serif; }
        #map { width: 100%; height: 100vh; }
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .source-test {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .testing { background-color: #fff3cd; border-color: #ffeaa7; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button {
            padding: 10px 15px;
            margin: 5px;
            cursor: pointer;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        h3 { margin-top: 0; }
    </style>
</head>
<body>
    <div id="info">
        <h3>üéØ Mapbox Boundaries Access Test</h3>
        <p><strong>Status:</strong> <span id="status">Initializing...</span></p>
        <div id="results"></div>
        <button onclick="testAllSources()" id="testBtn">Test All Sources</button>
        <button onclick="clearResults()">Clear Results</button>
        <button onclick="testLayers()" id="layerBtn" disabled>Test Layers</button>
    </div>
    <div id="map"></div>

    <script>
        // Get your Mapbox token from config.js
        const MAPBOX_TOKEN = 'pk.eyJ1IjoiY25hZ3JhcGhpY2Rlc2lnbiIsImEiOiJjbHRxbXlnc28wODF6Mmltb2Rjb3g5a25kIn0.x73wo3gKurL6CivFUOjVeg';
        
        mapboxgl.accessToken = MAPBOX_TOKEN;

        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/light-v11',
            center: [121.533, 25.057],
            zoom: 3
        });

        const sourcesToTest = [
            {
                id: 'boundaries-adm0-v1',
                url: 'mapbox://mapbox.country-boundaries-v1',
                name: 'Country Boundaries (adm0) - v1',
                sourceLayer: 'country_boundaries',
                expected: true
            },
            {
                id: 'boundaries-adm0-v3',
                url: 'mapbox://mapbox.boundaries-adm0-v3',
                name: 'Boundaries adm0-v3',
                sourceLayer: 'boundaries_adm0',
                expected: false
            },
            {
                id: 'boundaries-adm1-v3',
                url: 'mapbox://mapbox.boundaries-adm1-v3',
                name: 'State/Province Boundaries (adm1-v3)',
                sourceLayer: 'boundaries_adm1',
                expected: false
            },
            {
                id: 'boundaries-adm2-v3',
                url: 'mapbox://mapbox.boundaries-adm2-v3',
                name: 'County/City Boundaries (adm2-v3)',
                sourceLayer: 'boundaries_adm2',
                expected: false
            }
        ];

        const testResults = {};

        function addResult(source, status, message, details = '') {
            const resultsDiv = document.getElementById('results');
            const existing = resultsDiv.querySelector(`[data-source-id="${source.id}"]`);
            
            if (existing) {
                existing.className = `source-test ${status}`;
                existing.innerHTML = `
                    <strong>${source.name}</strong><br>
                    <small>${source.url}</small><br>
                    <span>${message}</span>
                    ${details ? `<br><small>${details}</small>` : ''}
                `;
            } else {
                const div = document.createElement('div');
                div.className = `source-test ${status}`;
                div.setAttribute('data-source-id', source.id);
                div.innerHTML = `
                    <strong>${source.name}</strong><br>
                    <small>${source.url}</small><br>
                    <span>${message}</span>
                    ${details ? `<br><small>${details}</small>` : ''}
                `;
                resultsDiv.appendChild(div);
            }
        }

        function removeSourceIfExists(sourceId) {
            try {
                if (map.getLayer(sourceId + '-layer')) {
                    map.removeLayer(sourceId + '-layer');
                }
                if (map.getSource(sourceId)) {
                    map.removeSource(sourceId);
                }
            } catch (e) {
                // Source doesn't exist, that's fine
            }
        }

        function testSource(source) {
            return new Promise((resolve) => {
                // Remove existing source/layer first
                removeSourceIfExists(source.id);
                
                addResult(source, 'testing', 'Testing...');
                document.getElementById('status').textContent = `Testing ${source.name}...`;
                
                let sourceLoaded = false;
                let errorOccurred = false;

                const onSourceData = (e) => {
                    if (e.sourceId === source.id && e.isSourceLoaded && !sourceLoaded) {
                        sourceLoaded = true;
                        testResults[source.id] = { success: true, source };
                        
                        addResult(source, 'success', 
                            '‚úÖ SUCCESS - Source loaded! You have ACCESS!', 
                            'Source is available and ready to use.');
                        resolve({ success: true, source });
                    }
                };

                const onError = (e) => {
                    if (errorOccurred) return;
                    
                    // Check if error is related to this source
                    if (e.error && (
                        e.error.message.includes(source.id) || 
                        e.error.message.includes('boundaries') ||
                        e.type === 'error'
                    )) {
                        errorOccurred = true;
                        const errorMsg = e.error ? e.error.message : 'Unknown error';
                        
                        if (errorMsg.includes('401') || errorMsg.includes('403') || errorMsg.includes('Forbidden')) {
                            testResults[source.id] = { success: false, source, error: 'NO_ACCESS' };
                            addResult(source, 'error', 
                                '‚ùå NO ACCESS - Requires special permissions',
                                `Error: ${errorMsg}`);
                        } else if (errorMsg.includes('404') || errorMsg.includes('Not Found')) {
                            testResults[source.id] = { success: false, source, error: 'NOT_FOUND' };
                            addResult(source, 'error', 
                                '‚ùå NOT FOUND - This tileset does not exist',
                                `Error: ${errorMsg}`);
                        } else {
                            testResults[source.id] = { success: false, source, error: 'OTHER' };
                            addResult(source, 'error', 
                                `‚ùå ERROR - ${errorMsg.substring(0, 100)}`,
                                `Full error: ${errorMsg}`);
                        }
                        resolve({ success: false, source, error: errorMsg });
                    }
                };

                map.on('sourcedata', onSourceData);
                map.on('error', onError);

                try {
                    map.addSource(source.id, {
                        type: 'vector',
                        url: source.url
                    });

                    // Try to add a layer to verify source works
                    setTimeout(() => {
                        if (!sourceLoaded && !errorOccurred) {
                            try {
                                map.addLayer({
                                    id: source.id + '-layer',
                                    type: 'fill',
                                    source: source.id,
                                    'source-layer': source.sourceLayer,
                                    paint: {
                                        'fill-color': '#0066ff',
                                        'fill-opacity': 0.2
                                    },
                                    filter: ['==', ['get', 'iso_3166_1_alpha_3'], 'TWN'] // Filter to Taiwan for testing
                                });
                                
                                // Wait a bit more to see if layer renders
                                setTimeout(() => {
                                    if (!sourceLoaded && !errorOccurred) {
                                        // Check if layer exists and is valid
                                        if (map.getLayer(source.id + '-layer')) {
                                            sourceLoaded = true;
                                            testResults[source.id] = { success: true, source };
                                            addResult(source, 'success', 
                                                '‚úÖ SUCCESS - Source and layer loaded! You have ACCESS!');
                                            resolve({ success: true, source });
                                        } else {
                                            // Source might have loaded but layer failed
                                            addResult(source, 'info', 
                                                '‚ö†Ô∏è Source added but layer creation needs verification',
                                                'Try clicking "Test Layers" button after source tests complete.');
                                            resolve({ success: false, source, needsVerification: true });
                                        }
                                    }
                                }, 2000);
                            } catch (layerError) {
                                if (!errorOccurred) {
                                    addResult(source, 'error', 
                                        `‚ùå Layer creation failed: ${layerError.message}`);
                                    resolve({ success: false, source, error: layerError.message });
                                }
                            }
                        }
                    }, 1000);

                    // Timeout after 10 seconds
                    setTimeout(() => {
                        if (!sourceLoaded && !errorOccurred) {
                            errorOccurred = true;
                            addResult(source, 'error', 
                                '‚è±Ô∏è TIMEOUT - Source did not load within 10 seconds',
                                'This might indicate no access or network issues.');
                            resolve({ success: false, source, timeout: true });
                        }
                    }, 10000);

                } catch (error) {
                    errorOccurred = true;
                    if (error.message.includes('already exists')) {
                        // Source already exists - that's actually good!
                        testResults[source.id] = { success: true, source, existing: true };
                        addResult(source, 'success', 
                            '‚úÖ SUCCESS - Source already exists! You have ACCESS!',
                            'Source was already loaded (likely from previous test).');
                        resolve({ success: true, source, existing: true });
                    } else {
                        addResult(source, 'error', 
                            `‚ùå ERROR - ${error.message}`);
                        resolve({ success: false, source, error: error.message });
                    }
                }
            });
        }

        async function testAllSources() {
            document.getElementById('testBtn').disabled = true;
            document.getElementById('status').textContent = 'Testing sources...';
            
            for (const source of sourcesToTest) {
                await testSource(source);
                await new Promise(resolve => setTimeout(resolve, 1500)); // Wait between tests
            }

            // Show summary
            showSummary();
            
            document.getElementById('testBtn').disabled = false;
            document.getElementById('layerBtn').disabled = false;
            document.getElementById('status').textContent = 'Testing complete!';
        }

        function showSummary() {
            const resultsDiv = document.getElementById('results');
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'source-test info';
            summaryDiv.style.marginTop = '20px';
            summaryDiv.style.padding = '15px';
            
            const adm1Success = testResults['boundaries-adm1-v3']?.success;
            const adm2Success = testResults['boundaries-adm2-v3']?.success;
            
            let summaryText = '<strong>üìä Summary:</strong><br><br>';
            
            if (adm1Success && adm2Success) {
                summaryText += '‚úÖ <strong>EXCELLENT NEWS!</strong><br>';
                summaryText += 'You have access to BOTH adm1 (states) and adm2 (counties) boundaries!<br>';
                summaryText += '‚úÖ <strong>You can use Mapbox Boundaries directly!</strong><br>';
                summaryText += '‚úÖ <strong>No GADM files needed!</strong><br><br>';
                summaryText += 'Click "Test Layers" to verify layers render correctly.';
            } else if (adm1Success || adm2Success) {
                summaryText += '‚ö†Ô∏è <strong>PARTIAL ACCESS</strong><br>';
                summaryText += `You have access to: ${adm1Success ? 'adm1' : ''}${adm1Success && adm2Success ? ' and ' : ''}${adm2Success ? 'adm2' : ''}<br>`;
                summaryText += 'You may need GADM files for the missing level.';
            } else {
                summaryText += '‚ùå <strong>NO ACCESS</strong><br>';
                summaryText += 'You do not have access to adm1/adm2 boundaries.<br>';
                summaryText += 'You will need to use GADM data conversion plan.';
            }
            
            summaryDiv.innerHTML = summaryText;
            resultsDiv.appendChild(summaryDiv);
        }

        function testLayers() {
            document.getElementById('layerBtn').disabled = true;
            document.getElementById('status').textContent = 'Testing layers...';
            
            // Test rendering adm1 layer for Taiwan
            if (testResults['boundaries-adm1-v3']?.success) {
                try {
                    removeSourceIfExists('boundaries-adm1-v3');
                    
                    map.addSource('boundaries-adm1-v3', {
                        type: 'vector',
                        url: 'mapbox://mapbox.boundaries-adm1-v3'
                    });
                    
                    map.addLayer({
                        id: 'test-adm1-layer',
                        type: 'fill',
                        source: 'boundaries-adm1-v3',
                        'source-layer': 'boundaries_adm1',
                        filter: ['==', ['get', 'iso_3166_1_alpha_3'], 'TWN'],
                        paint: {
                            'fill-color': '#ff0000',
                            'fill-opacity': 0.5
                        }
                    });
                    
                    map.addLayer({
                        id: 'test-adm1-outline',
                        type: 'line',
                        source: 'boundaries-adm1-v3',
                        'source-layer': 'boundaries_adm1',
                        filter: ['==', ['get', 'iso_3166_1_alpha_3'], 'TWN'],
                        paint: {
                            'line-color': '#000000',
                            'line-width': 2
                        }
                    });
                    
                    map.flyTo({ center: [121.533, 25.057], zoom: 7 });
                    
                    addResult(
                        { id: 'layer-test', name: 'Layer Rendering Test', url: '' },
                        'success',
                        '‚úÖ Layer added! Check map for red Taiwan states/provinces.'
                    );
                } catch (error) {
                    addResult(
                        { id: 'layer-test', name: 'Layer Rendering Test', url: '' },
                        'error',
                        `‚ùå Layer test failed: ${error.message}`
                    );
                }
            }
            
            document.getElementById('layerBtn').disabled = false;
            document.getElementById('status').textContent = 'Layer test complete!';
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            Object.keys(testResults).forEach(key => delete testResults[key]);
            document.getElementById('status').textContent = 'Cleared. Ready to test.';
        }

        // Initialize
        map.on('load', () => {
            document.getElementById('status').textContent = '‚úÖ Map loaded. Click "Test All Sources" to begin.';
            addResult(
                { id: 'init', name: 'Initialization', url: '' },
                'success',
                '‚úÖ Map loaded successfully. Ready to test sources.'
            );
        });
    </script>
</body>
</html>


