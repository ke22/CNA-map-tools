# 地图系统功能总结（中文版）

## 📋 核心功能概览

### 1. 区域着色
- **国家**：使用 Mapbox Boundaries 或 GADM 数据着色
- **州/省**：第一级行政区着色
- **市**：第二级行政区着色
- **样式**：填充模式（默认）或轮廓模式
- **数据源**：优先 Mapbox（快速），后备 GADM（详细）

### 2. 标记功能
- **多种形状**：Pin、Circle、Square 等
- **自定义颜色**：任意颜色选择
- **位置锁定**：标记始终固定在坐标，缩放不偏移
- **自适应缩放**：标记大小随地图缩放自动调整

### 3. 统一搜索
- **中文/英文地名**：自动识别并搜索
- **坐标搜索**：支持 `lat,lng` 或 `lng,lat` 格式
- **智能排序**：根据当前模式（区域/标记）优先显示相关结果
- **自动跳转**：选择结果后自动 flyTo 到目标位置

### 4. AI 分析
- **文本分析**：使用 Gemini API 分析新闻文本
- **自动提取**：地理区域（国家/行政区/城市）和地点坐标
- **批量应用**：一次性将分析结果应用到地图
- **优化**：缓存、去重、速率限制

---

## 🔄 主要运作流程

### 区域着色流程
```
搜索 → 显示结果 → 选择区域 → 切换数据源（如需要）→ 
加载边界数据 → ID 转换 → flyTo 到位置 → 应用颜色 → 更新列表
```

### 标记放置流程
```
搜索 → 显示结果 → 选择标记 → 解析坐标 → 
flyTo 到位置 → 添加标记 → 更新列表
```

### 标记缩放自适应
```
地图缩放 → 计算缩放比例 → 更新标记大小（width/height）→ 
锁定位置（setLngLat）→ zoomend 再次确认
```

---

## 🏗️ 系统架构

### 核心文件
- `app-enhanced.js`：地图初始化、区域着色、标记管理
- `unified-interface.js`：统一界面、搜索、模式切换
- `ai-assistant.js`：AI 分析功能
- `gemini-service.js`：Gemini API 服务
- `app-gadm.js`：GADM 数据加载
- `app-vector-tiles.js`：Mapbox 向量瓦片加载

### 关键状态
```javascript
appState = {
  currentAreaType: 'country' | 'administration',
  boundaryMode: 'fill' | 'outline',
  selectedAreas: [], // 已着色区域
  markers: [],       // 标记列表
  currentColor: '#6CA7A1',
  sources: {}        // 数据源状态
}

unifiedUI = {
  currentMode: 'area' | 'marker',
  currentFilter: 'all' | 'area' | 'marker'
}
```

---

## 🎯 关键技术特点

### 1. 数据源管理
- **混合策略**：Mapbox Boundaries（快速） + GADM（详细）
- **按需加载**：仅在需要时加载数据源
- **状态缓存**：避免重复加载

### 2. ID 转换机制
- **国家**：Mapbox ID → ISO 3166-1 alpha-3
  - 支持中文/英文名称查找
  - 简繁中文转换
- **行政区**：Mapbox ID → GADM GID
  - 使用 `queryRenderedFeatures` 查询
  - 多层 fallback 机制

### 3. 标记位置锁定
- **关键设计**：使用 `width/height` 而非 `transform: scale()`
- **原因**：transform 不改变 layout 大小，导致 Mapbox anchor 计算错误
- **实现**：直接修改元素尺寸，让 Mapbox 重新计算位置

### 4. 性能优化
- **API 缓存**：避免重复调用
- **请求去重**：防止同时发送相同请求
- **事件节流**：缩放事件优化
- **图层管理**：按需创建和移除

---

## 🎨 用户界面设计

### 统一工作流程
- **单一搜索框**：支持所有类型的搜索
- **模式切换**：区域模式 ↔ 标记模式
- **内容列表**：统一显示区域和标记
- **过滤器**：全部 / 仅区域 / 仅标记

### 样式工具
- **颜色选择器**：Hex 输入 + 预设颜色板
- **边界样式**：填充 / 轮廓切换
- **标记形状**：多种形状选择

---

## 💡 关键设计决策

1. **不使用 transform: scale()**：确保标记位置准确
2. **统一搜索入口**：简化用户界面
3. **静默切换数据源**：搜索时自动切换，不频繁改变 UI
4. **多层 ID 转换 Fallback**：提高转换成功率

---

## 📊 数据流

### 区域数据
```
搜索 → Mapbox Geocoding → Mapbox ID → 
ID 转换 → ISO/GADM GID → 加载数据源 → 
创建图层 → 应用颜色
```

### 标记数据
```
搜索 → Mapbox Geocoding / 坐标解析 → 
提取坐标 → 创建标记元素 → 
Mapbox Marker → 添加到地图
```

---

## 🚀 工作模式

### 区域模式
- **国家模式**：选择和着色国家
- **行政区模式**：选择和着色州/省或城市
- **边界样式**：填充或轮廓

### 标记模式
- **标记形状**：多种形状选择
- **标记颜色**：自定义颜色
- **坐标锁定**：始终固定在坐标

---

*详细文档请参阅：docs/SYSTEM_OVERVIEW.md*


