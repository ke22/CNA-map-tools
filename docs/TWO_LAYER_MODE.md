# 兩層疊加模式說明

## 📊 功能說明

實現了兩層疊加選擇功能：
- **第一層**：選擇國家（使用 Mapbox Boundaries）
- **第二層**：在選定國家內選擇行政區（使用 GADM 數據）

兩層同時顯示，方便查看和選擇。

## 🎯 使用流程

### 方式一：先選國家，再選行政區

1. 在"國家"模式下，點擊選擇一個國家
2. 切換到"行政區"模式
3. 在選定的國家內點擊選擇州/省或縣市
4. 兩層邊界同時顯示：
   - 國家邊界（較粗）
   - 行政區邊界（較細，疊加顯示）

### 方式二：直接選行政區（自動選擇國家）

1. 切換到"行政區"模式
2. 直接點擊地圖上的州/省或縣市
3. 系統會自動識別並選擇所屬國家
4. 國家層和行政區層同時顯示

## ✅ 已完成的改進

### 1. 名稱顯示改進

GADM 數據確實包含名稱屬性，已改進名稱獲取邏輯：

- **州/省名稱**：
  - 優先使用 `NL_NAME_1`（本地名稱，例如：高雄）
  - 備選 `NAME_1`（英文名稱，例如：Kaohsiung）

- **縣市名稱**：
  - 優先使用 `NL_NAME_2`（本地名稱）
  - 備選 `NAME_2`（英文名稱）

### 2. 兩層疊加實現

- 添加 `appState.selectedCountry` 追蹤選定國家
- 選擇國家時自動保存國家信息
- 行政區模式下保持國家層可見
- 兩層邊界同時顯示，視覺清晰

### 3. 智能關聯

- 選擇行政區時自動識別所屬國家
- 如果已選定國家，驗證行政區是否屬於該國家
- 如果不匹配，自動更新選定國家

## 🔧 技術實現

### 狀態管理

```javascript
appState.selectedCountry = {
    id: 'TWN',        // 國家代碼
    name: 'Taiwan'    // 國家名稱
}
```

### 圖層顯示順序

1. 基礎地圖層
2. 國家邊界層（如果已選定）
3. 行政區邊界層（州/省 + 縣市）
4. 已選擇區域的著色層

### 過濾邏輯

當選擇行政區時，系統會：
- 檢查 `GID_0` 屬性（國家代碼）
- 與 `appState.selectedCountry.id` 比對
- 確保只顯示和選擇屬於選定國家的行政區

## 📝 GADM 數據屬性

### 州/省（Level 1）屬性：

- `GID_0`: 國家代碼（例如：TWN）
- `GID_1`: 州/省代碼（例如：TWN.1_1）
- `NAME_1`: 英文名稱（例如：Kaohsiung）
- `NL_NAME_1`: 本地名稱（例如：高雄）
- `COUNTRY`: 國家名稱（例如：Taiwan）

### 縣市（Level 2）屬性：

- `GID_0`: 國家代碼
- `GID_1`: 州/省代碼
- `GID_2`: 縣市代碼
- `NAME_2`: 英文名稱
- `NL_NAME_2`: 本地名稱
- `NAME_1`: 所屬州/省名稱

## 🚀 使用建議

1. **第一次使用**：
   - 先在"國家"模式下選擇目標國家
   - 然後切換到"行政區"模式進行細化選擇

2. **快速選擇**：
   - 直接在"行政區"模式下點擊
   - 系統會自動識別國家

3. **多國家選擇**：
   - 每次選擇一個國家的行政區
   - 選擇其他國家時，系統會自動切換

## ⚠️ 注意事項

- GADM 數據文件較大，首次加載可能需要一些時間
- 確保 `data/gadm/optimized/` 目錄下有優化後的 GeoJSON 文件
- 如果名稱顯示不正確，檢查瀏覽器控制台的錯誤訊息

## 🔄 未來優化

- [ ] 添加國家選擇器，快速切換目標國家
- [ ] 實現行政區預過濾（只加載選定國家的數據）
- [ ] 添加圖層透明度控制
- [ ] 優化大數據量的渲染性能


