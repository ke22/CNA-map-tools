# 已知问题和待办事项

> 此文件用于跨工作阶段共享上下文，记录技术债、发现的问题和待办事项

## 🔴 技术债

### 高优先级
- [ ] **GADM 数据文件过大**
  - 问题: Level 0 文件 121.75 MB，Level 1 文件 88.20 MB
  - 影响: 加载时间长，可能造成内存问题
  - 解决方案: 进一步优化（增加简化比例）或考虑使用矢量瓦片
  - 状态: 已优化，但可进一步改进

- [ ] **中文标签移动后颜色恢复延迟**
  - 问题: 移动标签后，取消选择时颜色恢复有短暂延迟
  - 原因: Mapbox 数据源更新和样式应用有时序问题
  - 解决方案: 已添加 `setTimeout` 延迟，但可能需要更好的同步机制
  - 状态: 部分修复，需持续观察

### 中优先级
- [ ] **边界查询性能**
  - 问题: `queryRenderedFeatures` 在某些缩放级别不准确，需要回退到 point-in-polygon
  - 影响: 性能可能受影响（特别是大数据集）
  - 解决方案: 优化 point-in-polygon 算法或使用空间索引
  - 状态: 有回退机制，但可优化

- [ ] **AI 分析置信度阈值**
  - 问题: 当前阈值 0.75 可能过滤掉一些相关国家
  - 影响: 某些边缘案例可能被遗漏
  - 解决方案: 根据实际使用情况调整阈值，或提供用户可配置选项
  - 状态: 需要更多测试数据验证

### 低优先级
- [ ] **测试覆盖不完整**
  - 问题: 某些边缘情况未覆盖（如标签拖拽到地图外）
  - 解决方案: 逐步添加更多测试用例
  - 状态: 持续改进中

---

## 🟡 发现和观察

### GADM 4.1.0 处理
- **发现**: GADM 4.1.0 使用单一 GPKG 文件，包含所有级别
- **处理**: 需要特殊转换脚本 (`convert-gadm-410.js`)
- **图层名称**: 可能使用 `level0`, `level1`, `gadm_level0` 等不同命名
- **状态**: 已实现自动检测和转换

### Mapbox 查询限制
- **发现**: `map.queryRenderedFeatures()` 在某些缩放级别和边界情况下不准确
- **解决方案**: 实现了自定义 point-in-polygon 测试作为回退
- **性能**: 对于 263 个国家的数据集，回退查询仍然可接受
- **状态**: 已实现，工作正常

### 中文标签对齐
- **发现**: 中文标签需要对齐到 Mapbox 英文名称位置
- **实现**: 使用 `_textAnchor` 和 `_textOffset` 数据属性
- **状态**: 已实现，工作正常

### AI 提取规则
- **发现**: 新闻中的地理位置提取需要区分"事件主角"和"背景提及"
- **实现**: 使用置信度评分和关键词过滤
- **状态**: 已优化，持续改进中

---

## 🟢 已解决的问题

### ✅ 协议检测和错误处理
- **问题**: 使用 `file://` 协议会导致 CORS 错误
- **解决**: 实现了协议检测，显示友好的错误页面
- **状态**: 已解决

### ✅ 重复查询日志
- **问题**: `mousemove` 事件导致大量重复查询日志
- **解决**: 实现了 300ms 防抖
- **状态**: 已解决

### ✅ 邻近国家中文标签颜色
- **问题**: 邻近国家标签未显示为灰色
- **解决**: 修复了 `updateLabelHighlight()` 函数，确保三层格式正确应用
- **状态**: 已解决

### ✅ 标签移动后颜色保持
- **问题**: 移动标签后，取消选择时颜色未恢复
- **解决**: 确保 `labelType` 属性在移动时保留，并在取消选择时正确恢复样式
- **状态**: 已解决

---

## 📋 待办事项

### 功能增强
- [ ] 添加标签撤销/重做功能
- [ ] 支持标签批量操作
- [ ] 添加地图预设视图（快速跳转到特定区域）
- [ ] 支持自定义颜色调色板

### 性能优化
- [ ] 实现 GADM 数据的懒加载（按需加载）
- [ ] 优化大型 GeoJSON 的渲染性能
- [ ] 添加数据缓存机制

### 用户体验
- [ ] 添加加载进度指示器
- [ ] 改进错误消息的用户友好性
- [ ] 添加键盘快捷键支持

### 文档
- [ ] 完善 API 文档
- [ ] 添加更多使用示例
- [ ] 创建视频教程

---

## 🔍 调试技巧

### 检查 GADM 数据加载
```javascript
// 在浏览器控制台运行
const source = map.getSource('gadm-country');
console.log('Features:', source._data.features.length);
```

### 检查中文标签
```javascript
// 检查标签数据
const labelSource = map.getSource('custom-chinese-labels');
console.log('Labels:', labelSource._data.features);
```

### 检查 AI 分析结果
```javascript
// 查看 AI 提取的地理位置
// 在 AI 助手面板中查看控制台输出
```

---

## 📝 笔记

### 2024-12-19
- 完成了 GADM 4.1.0 转换脚本优化
- 实现了中文标签三层格式系统
- 修复了标签移动后颜色保持问题
- 建立了 CLAUDE.md 和 shared-context 系统

### 下一步计划
1. 完善 Playwright 测试覆盖
2. 优化 GADM 文件大小
3. 考虑实现 CI/CD 自动化

---

**最后更新**: 2024-12-19

